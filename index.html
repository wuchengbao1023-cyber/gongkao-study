<!DOCTYPE html>
<html>
<head>
    <title>å…¬è€ƒå¾ªç¯å­¦ä¹ ç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* åŸºç¡€é‡ç½® */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif; 
            line-height: 1.5;
            color: #333;
            background: #f5f7fa;
            padding: 15px;
            min-height: 100vh;
        }
        
        /* å®¹å™¨ */
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            text-align: center;
            min-width: 80px;
        }
        
        .status-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: #1a237e;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ - å“åº”å¼å¸ƒå±€ */
        .main-content {
            display: block;
        }
        
        @media (min-width: 768px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 20px;
            }
        }
        
        /* å·¦ä¾§ï¼šå­¦ä¹ åŒº */
        .learning-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* AIæé†’ */
        .ai-reminder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .ai-message {
            flex: 1;
            font-size: 15px;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* æ¨¡å—åˆ—è¡¨ */
        .modules-list {
            margin-top: 25px;
        }
        
        .module-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .module-item.completed {
            background: #f0f9f0;
            border-color: #c8e6c9;
        }
        
        .module-item.current {
            background: #e3f2fd;
            border-color: #90caf9;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 rgba(33, 150, 243, 0); }
            50% { box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); }
        }
        
        .module-number {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 24px;
            height: 24px;
            background: #1a237e;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
        }
        
        .module-content {
            margin-left: 30px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .module-title {
            font-weight: bold;
            font-size: 16px;
            color: #1a237e;
        }
        
        .module-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #e0e0e0;
            color: #666;
        }
        
        .module-status.completed {
            background: #4caf50;
            color: white;
        }
        
        .module-status.current {
            background: #2196f3;
            color: white;
        }
        
        .module-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .module-stats {
            font-size: 12px;
            color: #666;
            background: rgba(0,0,0,0.03);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .module-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            min-width: 44px;
            user-select: none;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-complete {
            background: #4caf50;
            color: white;
            flex: 1;
        }
        
        .btn-edit {
            background: #ff9800;
            color: white;
        }
        
        .btn-reset {
            background: #f44336;
            color: white;
        }
        
        .btn-manage {
            background: #2196f3;
            color: white;
        }
        
        /* å³ä¾§ï¼šç»Ÿè®¡åŒº */
        .stats-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stats-card {
            margin-bottom: 25px;
        }
        
        .stats-card:last-child {
            margin-bottom: 0;
        }
        
        .stats-title {
            font-size: 16px;
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a237e;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        /* æ¨¡å—æ’è¡Œ */
        .rank-list {
            list-style: none;
        }
        
        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .rank-item:last-child {
            border-bottom: none;
        }
        
        .rank-name {
            font-size: 14px;
            flex: 1;
        }
        
        .rank-value {
            font-weight: bold;
            color: #1a237e;
        }
        
        .rank-trend {
            font-size: 12px;
            margin-left: 8px;
        }
        
        .trend-up { color: #4caf50; }
        .trend-down { color: #f44336; }
        
        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        /* é”™è¯¯æç¤º */
        .error-text {
            color: #f44336;
            font-size: 13px;
            margin-top: 5px;
        }
        
        /* æ¨¡å—ç®¡ç† */
        .module-edit-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
        }
        
        .module-edit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        /* é‡ç½®ç¡®è®¤ */
        .reset-confirm {
            text-align: center;
            padding: 20px;
        }
        
        .reset-input {
            margin: 20px 0;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: #666;
            font-size: 13px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            text-align: center;
            padding: 40px;
        }
        
        .loader::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-info">
                <div class="status-item">
                    <div class="status-label">å½“å‰è½®æ¬¡</div>
                    <div class="status-value" id="currentRound">1</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æœ¬è½®è¿›åº¦</div>
                    <div class="status-value" id="todayProgress">0/8</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ€»é¢˜æ•°</div>
                    <div class="status-value" id="totalQuestions">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ­£ç¡®ç‡</div>
                    <div class="status-value" id="accuracyRate">0%</div>
                </div>
            </div>
            <div>
                <button class="btn btn-manage" onclick="showEditModal()">
                    <span>âš™ï¸</span>
                    <span class="desktop-only">æ¨¡å—ç®¡ç†</span>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šå­¦ä¹ åŒº -->
            <div class="learning-area">
                <!-- AIæé†’ -->
                <div class="ai-reminder">
                    <div class="ai-icon">ğŸ‘¨â€ğŸ«</div>
                    <div class="ai-message" id="aiMessage">æ¬¢è¿ä½¿ç”¨ï¼ä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ï¼</div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container">
                    <div class="progress-header">
                        <div>æœ¬è½®è¿›åº¦</div>
                        <div id="progressPercent">0%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- æ¨¡å—åˆ—è¡¨ -->
                <div class="modules-list" id="modulesList">
                    <!-- æ¨¡å—ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç»Ÿè®¡åŒº -->
            <div class="stats-area">
                <!-- æ€»ä½“ç»Ÿè®¡ -->
                <div class="stats-card">
                    <div class="stats-title">ğŸ“Š æ€»ä½“ç»Ÿè®¡</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">æ€»è½®æ•°</div>
                            <div class="stat-value" id="statTotalRounds">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æ€»å¤©æ•°</div>
                            <div class="stat-value" id="statTotalDays">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">è¿ç»­å­¦ä¹ </div>
                            <div class="stat-value" id="statStreakDays">0</div>
                            <div class="stat-label" id="streakStatus">å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æ€»è€—æ—¶</div>
                            <div class="stat-value" id="statTotalTime">0</div>
                            <div class="stat-label">å°æ—¶</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨¡å—æ’è¡Œ -->
                <div class="stats-card">
                    <div class="stats-title">ğŸ“ˆ æ¨¡å—æ’è¡Œ</div>
                    <ul class="rank-list" id="rankList">
                        <!-- æ’è¡Œç”±JSç”Ÿæˆ -->
                    </ul>
                </div>
                
                <!-- æœ¬è½®çŠ¶æ€ -->
                <div class="stats-card">
                    <div class="stats-title">ğŸ¯ æœ¬è½®çŠ¶æ€</div>
                    <div id="dailyStatus" style="font-size: 14px; line-height: 1.6;">
                        æœ¬è½®å°šæœªå¼€å§‹å­¦ä¹ 
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="control-buttons">
            <button class="btn btn-reset" onclick="showResetModal()">
                <span>ğŸ”„</span>
                é‡ç½®æœ¬è½®
            </button>
            <button class="btn btn-reset" onclick="showClearAllModal()" style="background: #9c27b0;">
                <span>ğŸ—‘ï¸</span>
                æ¸…ç©ºæ•°æ®
            </button>
            <button class="btn btn-manage" onclick="exportData()">
                <span>ğŸ“¤</span>
                å¯¼å‡ºæ•°æ®
            </button>
        </div>
        
        <div class="footer">
            æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ Â· åˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±
        </div>
    </div>
    
    <!-- å®Œæˆæ¨¡å—å¼¹çª— -->
    <div id="completeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">âœ… å®Œæˆæ¨¡å—</h3>
            </div>
            <div id="completeModuleInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <!-- æ¨¡å—ä¿¡æ¯ -->
            </div>
            <form id="completeForm" onsubmit="return false;">
                <div class="form-group">
                    <label class="form-label">æœ¬æ¬¡é”™é¢˜æ•°ï¼š</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="range" id="wrongRange" min="0" max="20" value="0" style="flex: 1;">
                        <input type="number" id="wrongInput" class="form-input" min="0" max="20" value="0" 
                               style="width: 80px; text-align: center;" required>
                        <span>/<span id="maxQuestions">20</span>é¢˜</span>
                    </div>
                    <div id="wrongHint" style="margin-top: 8px; font-size: 13px; color: #666;">
                        å…¨å¯¹ï¼ç»§ç»­ä¿æŒï¼
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <textarea id="noteInput" class="form-input" rows="3" 
                              placeholder="è®°å½•æœ¬æ¬¡ç»ƒä¹ çš„é—®é¢˜æˆ–å¿ƒå¾—..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn" onclick="closeCompleteModal()" style="flex: 1; background: #e0e0e0;">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-complete" onclick="submitComplete()" style="flex: 2;">
                        âœ… ç¡®è®¤å®Œæˆ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¨¡å—å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">âš™ï¸ æ¨¡å—ç®¡ç†</h3>
            </div>
            
            <div class="module-edit-list" id="moduleEditList">
                <!-- ç¼–è¾‘åˆ—è¡¨ç”±JSç”Ÿæˆ -->
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-manage" onclick="showAddModuleModal()">
                    <span>â•</span>
                    æ·»åŠ æ–°æ¨¡å—
                </button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-complete" onclick="saveModules()" style="flex: 1;">
                    ğŸ’¾ ä¿å­˜è®¾ç½®
                </button>
                <button class="btn" onclick="closeEditModal()" style="flex: 1; background: #e0e0e0;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ¨¡å—å¼¹çª— -->
    <div id="addModuleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;">â• æ·»åŠ æ–°æ¨¡å—</h3>
            </div>
            <form id="addModuleForm" onsubmit="return false;">
                <div class="form-group">
                    <label class="form-label">æ¨¡å—åç§°ï¼š</label>
                    <input type="text" id="newModuleName" class="form-input" 
                           placeholder="ä¾‹å¦‚ï¼šç”³è®ºå†™ä½œè®­ç»ƒ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å—åˆ†ç±»ï¼š</label>
                    <select id="newModuleCategory" class="form-input">
                        <option value="è¨€è¯­ç†è§£">è¨€è¯­ç†è§£</option>
                        <option value="åˆ¤æ–­æ¨ç†">åˆ¤æ–­æ¨ç†</option>
                        <option value="èµ„æ–™åˆ†æ">èµ„æ–™åˆ†æ</option>
                        <option value="æ•°é‡å…³ç³»">æ•°é‡å…³ç³»</option>
                        <option value="ç”³è®º">ç”³è®º</option>
                        <option value="å¸¸è¯†">å¸¸è¯†</option>
                        <option value="ä¸“é¡¹è®­ç»ƒ">ä¸“é¡¹è®­ç»ƒ</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                        <input type="number" id="newModuleTime" class="form-input" 
                               min="5" max="180" value="30" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢˜é‡ï¼š</label>
                        <input type="number" id="newModuleQuestions" class="form-input" 
                               min="1" max="100" value="20" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">è¾“å‡ºä»»åŠ¡æè¿°ï¼š</label>
                    <textarea id="newModuleDesc" class="form-input" rows="3" 
                              placeholder="ä¾‹å¦‚ï¼šæ¯é¢˜æ€»ç»“è§£é¢˜æ€è·¯"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAddModuleModal()" 
                            style="flex: 1; background: #e0e0e0;">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-complete" onclick="addModule()" style="flex: 1;">
                        æ·»åŠ 
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- é‡ç½®ç¡®è®¤å¼¹çª— -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="reset-confirm">
                <h3 style="margin-bottom: 15px;">ğŸ”„ é‡ç½®æœ¬è½®è¿›åº¦</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    è¿™å°†æ¸…ç©ºæœ¬è½®æ‰€æœ‰æ¨¡å—çš„å®ŒæˆçŠ¶æ€ï¼Œä½†ä¸ä¼šåˆ é™¤å†å²æ•°æ®ã€‚
                </p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="closeResetModal()" style="flex: 1; background: #e0e0e0;">
                        å–æ¶ˆ
                    </button>
                    <button class="btn btn-reset" onclick="resetToday()" style="flex: 1;">
                        ç¡®è®¤é‡ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¸…ç©ºæ•°æ®å¼¹çª— -->
    <div id="clearAllModal" class="modal">
        <div class="modal-content">
            <div class="reset-confirm">
                <h3 style="margin-bottom: 15px; color: #f44336;">âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</h3>
                <p style="margin-bottom: 15px; color: #666;">
                    è¿™å°†åˆ é™¤æ‰€æœ‰å­¦ä¹ è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
                </p>
                <ul style="text-align: left; margin-bottom: 20px; padding-left: 20px; color: #666;">
                    <li>æ‰€æœ‰æ¨¡å—çš„å†å²æ•°æ®</li>
                    <li>æ€»ä½“ç»Ÿè®¡ä¿¡æ¯</li>
                    <li>è¿ç»­å­¦ä¹ è®°å½•</li>
                    <li>è‡ªå®šä¹‰çš„æ¨¡å—è®¾ç½®</li>
                </ul>
                <p style="margin-bottom: 20px; color: #f44336; font-weight: bold;">
                    æ­¤æ“ä½œä¸å¯æ¢å¤ï¼è¯·è°¨æ…æ“ä½œã€‚
                </p>
                <div class="form-group">
                    <label class="form-label">è¯·è¾“å…¥"RESET"ç¡®è®¤ï¼š</label>
                    <input type="text" id="resetConfirmInput" class="reset-input" 
                           placeholder="RESET" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="closeClearAllModal()" 
                            style="flex: 1; background: #e0e0e0;">
                        å–æ¶ˆ
                    </button>
                    <button class="btn btn-reset" onclick="clearAllData()" 
                            style="flex: 1;" disabled id="clearAllBtn">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å­¦ä¹ æ•°æ®
        const studyData = {
            // ç³»ç»ŸçŠ¶æ€
            currentDate: '',
            currentRound: 1,
            currentModuleIndex: 0,
            todayCompleted: 0,
            totalRounds: 0,
            
            // æ€»ä½“ç»Ÿè®¡
            overall: {
                totalQuestions: 0,
                totalCorrect: 0,
                streakDays: 0,
                totalDays: 0,
                lastStudyDate: '',
                totalTime: 0 // åˆ†é’Ÿ
            },
            
            // æ¨¡å—å®šä¹‰ï¼ˆé»˜è®¤ï¼‰
            modules: [
                { 
                    id: 1, 
                    name: "è¨€è¯­ç‰‡æ®µé˜…è¯»", 
                    category: "è¨€è¯­ç†è§£",
                    time: 30, 
                    questions: 20, 
                    desc: "æ¯é¢˜â‰¤10å­—å†™æ ¸å¿ƒè®ºç‚¹",
                    order: 1 
                },
                { 
                    id: 2, 
                    name: "é€»è¾‘åˆ¤æ–­", 
                    category: "åˆ¤æ–­æ¨ç†",
                    time: 35, 
                    questions: 20, 
                    desc: "å†™è®ºè¯ç±»å‹+é€»è¾‘é“¾",
                    order: 2 
                },
                { 
                    id: 3, 
                    name: "èµ„æ–™åˆ†æ", 
                    category: "èµ„æ–™åˆ†æ",
                    time: 35, 
                    questions: 20, 
                    desc: "å£è¿°æœ€éš¾è®¡ç®—æ€è·¯",
                    order: 3 
                },
                { 
                    id: 4, 
                    name: "è¨€è¯­å¡«ç©º", 
                    category: "è¨€è¯­ç†è§£",
                    time: 30, 
                    questions: 20, 
                    desc: "è®°å½•çŠ¹è±«é€‰é¡¹å¹¶è¾¨æ",
                    order: 4 
                },
                { 
                    id: 5, 
                    name: "å›¾å½¢æ¨ç†", 
                    category: "åˆ¤æ–­æ¨ç†",
                    time: 25, 
                    questions: 20, 
                    desc: "æ³¨é”™/æ…¢é¢˜'æ­»åœ¨ä½•æ­¥'",
                    order: 5 
                },
                { 
                    id: 6, 
                    name: "å®šä¹‰åˆ¤æ–­", 
                    category: "åˆ¤æ–­æ¨ç†",
                    time: 25, 
                    questions: 20, 
                    desc: "å…ˆè‡ªè¯é‡è¿°å®šä¹‰",
                    order: 6 
                },
                { 
                    id: 7, 
                    name: "ç±»æ¯”æ¨ç†", 
                    category: "åˆ¤æ–­æ¨ç†",
                    time: 20, 
                    questions: 20, 
                    desc: "é”™é¢˜åå‘æ„é€ ä¾‹å­",
                    order: 7 
                },
                { 
                    id: 8, 
                    name: "ç»ˆæä»»åŠ¡", 
                    category: "ç»¼åˆè®­ç»ƒ",
                    time: 60, 
                    questions: 1, 
                    desc: "ç”³è®º/é”™æ€/ä½“èƒ½ä¸‰é€‰ä¸€",
                    order: 8 
                }
            ],
            
            // æ¨¡å—ç»Ÿè®¡æ•°æ®
            moduleStats: {},
            
            // æ¯æ—¥è®°å½•
            daily: {
                date: '',
                completed: [], // å·²å®Œæˆçš„æ¨¡å—ID
                startTime: 0,
                totalTime: 0
            },
            
            // å†å²è®°å½•
            history: []
        };
        
        // AIæ¶ˆæ¯åº“
        const aiMessages = {
            morning: [
                "æ—©ä¸Šå¥½ï¼ä¸€æ—¥ä¹‹è®¡åœ¨äºæ™¨ï¼Œå¼€å§‹ä»Šå¤©çš„å­¦ä¹ å§ï¼",
                "æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼å…¨åŠ›ä»¥èµ´ï¼",
                "æ—©ä¸Šå¤´è„‘æœ€æ¸…é†’ï¼Œé€‚åˆæ”»å…‹éš¾é¢˜ï¼"
            ],
            afternoon: [
                "åˆä¼‘ç»“æŸï¼Œå¼€å§‹ä¸‹åˆçš„æˆ˜æ–—å§ï¼",
                "ä¸‹åˆå®¹æ˜“çŠ¯å›°ï¼Œæ‰“èµ·ç²¾ç¥æ¥ï¼",
                "ä¸‹åˆæ˜¯å·©å›ºçŸ¥è¯†çš„å¥½æ—¶æœºï¼"
            ],
            evening: [
                "æ™šä¸Šæ˜¯å­¦ä¹ çš„é»„é‡‘æ—¶é—´ï¼",
                "æ™šä¸Šå®‰é™ï¼Œé€‚åˆæ·±åº¦æ€è€ƒï¼",
                "åšæŒåˆ°æ™šä¸Šå°±æ˜¯èƒœåˆ©ï¼"
            ],
            completed: [
                "å®Œæˆï¼ç»§ç»­ä¿æŒè¿™ä¸ªçŠ¶æ€ï¼",
                "åšå¾—å¥½ï¼ç¦»ç›®æ ‡åˆè¿‘äº†ä¸€æ­¥ï¼",
                "ä¸é”™ï¼è®°å¾—æ€»ç»“é”™é¢˜ï¼"
            ],
            perfect: [
                "å…¨å¯¹ï¼å¤ªå¼ºäº†ï¼å¤©æ‰æ°´å¹³ï¼",
                "å®Œç¾ï¼ç»§ç»­ä¿æŒï¼",
                "100%æ­£ç¡®ç‡ï¼ä½ å°±æ˜¯æœ€æ£’çš„ï¼"
            ],
            warning: [
                "æ­£ç¡®ç‡åä½ï¼Œéœ€è¦åŠ å¼ºå¤ä¹ ï¼",
                "é”™é¢˜æœ‰ç‚¹å¤šï¼Œè¦é‡ç‚¹åˆ†æï¼",
                "æ³¨æ„ï¼è¿™ä¸ªæ¨¡å—éœ€è¦åŠ å¼ºï¼"
            ],
            progress: [
                "å·²å®Œæˆä¸€åŠä»»åŠ¡ï¼ç»§ç»­åŠ æ²¹ï¼",
                "è¿›åº¦ä¸é”™ï¼Œä¿æŒè¿™ä¸ªèŠ‚å¥ï¼",
                "ä»Šå¤©çŠ¶æ€å¾ˆå¥½ï¼Œç»§ç»­æ¨è¿›ï¼"
            ],
            lazy: [
                "æ£€æµ‹åˆ°é•¿æ—¶é—´æ— æ“ä½œï¼Œå¿«å›æ¥å­¦ä¹ ï¼",
                "åˆ«åˆ†å¿ƒï¼Œé›†ä¸­æ³¨æ„åŠ›ï¼",
                "è¯¥ç»§ç»­å­¦ä¹ äº†ï¼"
            ]
        };
        
        // åˆå§‹åŒ–
        function init() {
            loadData();
            checkNewDay();
            updateDisplay();
            setupEventListeners();
            updateAIMessage();
        }
        
        function loadData() {
            const saved = localStorage.getItem('studyData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // åˆå¹¶æ•°æ®ï¼Œä¿ç•™æ–°ç‰ˆæœ¬å¯èƒ½æ–°å¢çš„å­—æ®µ
                    Object.keys(data).forEach(key => {
                        if (studyData[key] !== undefined) {
                            if (typeof studyData[key] === 'object' && studyData[key] !== null) {
                                Object.assign(studyData[key], data[key]);
                            } else {
                                studyData[key] = data[key];
                            }
                        }
                    });
                    
                    // åˆå§‹åŒ–moduleStats
                    studyData.modules.forEach(module => {
                        if (!studyData.moduleStats[module.id]) {
                            studyData.moduleStats[module.id] = {
                                attempts: 0,
                                totalQuestions: 0,
                                totalCorrect: 0,
                                bestAccuracy: 0,
                                lastAccuracy: 0,
                                history: []
                            };
                        }
                    });
                    
                    console.log('æ•°æ®åŠ è½½æˆåŠŸ');
                } catch (e) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', e);
                    // ä½¿ç”¨é»˜è®¤æ•°æ®
                }
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem('studyData', JSON.stringify(studyData));
            } catch (e) {
                console.error('æ•°æ®ä¿å­˜å¤±è´¥', e);
                alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³');
            }
        }
        
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªå®Œæˆæ¨¡å—çš„ç´¢å¼•
        function findFirstIncompleteModule() {
            for (let i = 0; i < studyData.modules.length; i++) {
                if (!studyData.daily.completed.includes(studyData.modules[i].id)) {
                    return i; // è¿”å›ç¬¬ä¸€ä¸ªæœªå®Œæˆæ¨¡å—çš„ç´¢å¼•
                }
            }
            return 0; // å¦‚æœå…¨éƒ¨å®Œæˆäº†ï¼ˆä¾‹å¦‚åˆšå®Œæˆä¸€è½®ï¼‰ï¼Œå°±è¿”å›0å¼€å§‹æ–°ä¸€è½®
        }
        
        // æ£€æŸ¥æ˜¯å¦æ–°çš„ä¸€å¤©
        function checkNewDay() {
            const today = getTodayDate();
            
            if (studyData.currentDate !== today) {
                console.log('æ–°çš„ä¸€å¤©å¼€å§‹');
                
                // ä¿å­˜å‰ä¸€å¤©çš„å†å²è®°å½•
                if (studyData.daily.date && studyData.daily.completed.length > 0) {
                    studyData.history.push({
                        date: studyData.daily.date,
                        completed: [...studyData.daily.completed],
                        totalTime: studyData.daily.totalTime
                    });
                    
                    // åªä¿ç•™æœ€è¿‘30å¤©çš„å†å²
                    if (studyData.history.length > 30) {
                        studyData.history.shift();
                    }
                }
                
                // æ£€æŸ¥è¿ç»­å­¦ä¹ 
                const yesterday = getYesterdayDate();
                if (studyData.overall.lastStudyDate === yesterday) {
                    studyData.overall.streakDays++;
                    updateAIMessage('streak');
                } else if (studyData.overall.lastStudyDate !== today) {
                    studyData.overall.streakDays = 1;
                    updateAIMessage('reset');
                }
                
                // æ›´æ–°æ—¥æœŸç›¸å…³æ•°æ®
                studyData.currentDate = today;
                studyData.overall.lastStudyDate = today;
                studyData.overall.totalDays++;
                
                // ========== æ ¸å¿ƒä¿®æ”¹1ï¼šæ–°çš„ä¸€å¤©ä¸é‡ç½®è¿›åº¦ ==========
                studyData.daily.date = today;
                studyData.daily.startTime = Date.now();
                // ä¸å†é‡ç½® todayCompleted, currentModuleIndex å’Œ daily.completed
                // ==================================================
                
                // ç¡®ä¿å½“å‰æ¨¡å—ç´¢å¼•æŒ‡å‘ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„æ¨¡å—
                studyData.currentModuleIndex = findFirstIncompleteModule();
                
                saveData();
            }
        }
        
        function getTodayDate() {
            const now = new Date();
            return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        }
        
        function getYesterdayDate() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return `${yesterday.getFullYear()}-${(yesterday.getMonth() + 1).toString().padStart(2, '0')}-${yesterday.getDate().toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
            document.getElementById('currentRound').textContent = studyData.currentRound;
            
            // ========== æ ¸å¿ƒä¿®æ”¹2ï¼šä»Šæ—¥è¿›åº¦æ”¹ä¸ºæ˜¾ç¤ºå½“å‰è½®æ¬¡è¿›åº¦ ==========
            const totalModules = studyData.modules.length;
            const completedInThisRound = studyData.daily.completed.length;
            document.getElementById('todayProgress').textContent = `${completedInThisRound}/${totalModules}`;
            // =======================================================
            
            document.getElementById('totalQuestions').textContent = studyData.overall.totalQuestions;
            
            // è®¡ç®—æ­£ç¡®ç‡
            const accuracy = studyData.overall.totalQuestions > 0 ? 
                ((studyData.overall.totalCorrect / studyData.overall.totalQuestions) * 100).toFixed(1) : 0;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
            
            // æ›´æ–°è¿›åº¦æ¡ï¼ˆæ˜¾ç¤ºå½“å‰è½®æ¬¡è¿›åº¦ï¼‰
            const progressPercent = (completedInThisRound / totalModules) * 100;
            document.getElementById('progressPercent').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            
            // æ›´æ–°å³ä¾§ç»Ÿè®¡
            document.getElementById('statTotalRounds').textContent = studyData.totalRounds;
            document.getElementById('statTotalDays').textContent = studyData.overall.totalDays;
            document.getElementById('statStreakDays').textContent = studyData.overall.streakDays;
            
            // æ€»è€—æ—¶ï¼ˆå°æ—¶ï¼‰
            const totalHours = (studyData.overall.totalTime / 60).toFixed(1);
            document.getElementById('statTotalTime').textContent = totalHours;
            
            // æ›´æ–°è¿ç»­å­¦ä¹ çŠ¶æ€
            const streakStatus = document.getElementById('streakStatus');
            if (studyData.overall.streakDays >= 30) {
                streakStatus.textContent = 'å¤© ğŸ”¥';
            } else if (studyData.overall.streakDays >= 15) {
                streakStatus.textContent = 'å¤© ğŸš€';
            } else if (studyData.overall.streakDays >= 7) {
                streakStatus.textContent = 'å¤© ğŸ’ª';
            } else {
                streakStatus.textContent = 'å¤©';
            }
            
            // æ›´æ–°æ¨¡å—åˆ—è¡¨
            updateModuleList();
            
            // æ›´æ–°æ¨¡å—æ’è¡Œ
            updateRankList();
            
            // æ›´æ–°ä»Šæ—¥çŠ¶æ€
            updateDailyStatus();
            
            // ä¿å­˜æ•°æ®
            saveData();
        }
        
        // æ›´æ–°æ¨¡å—åˆ—è¡¨
        function updateModuleList() {
            const container = document.getElementById('modulesList');
            container.innerHTML = '';
            
            studyData.modules.forEach((module, index) => {
                const stats = studyData.moduleStats[module.id] || {
                    attempts: 0,
                    totalQuestions: 0,
                    totalCorrect: 0
                };
                
                const isCompleted = studyData.daily.completed.includes(module.id);
                const isCurrent = index === studyData.currentModuleIndex && !isCompleted;
                
                // è®¡ç®—å†å²æ­£ç¡®ç‡
                const historyAccuracy = stats.attempts > 0 ? 
                    ((stats.totalCorrect / stats.totalQuestions) * 100).toFixed(1) : 0;
                
                const moduleDiv = document.createElement('div');
                moduleDiv.className = `module-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;
                
                // çŠ¶æ€æ–‡æœ¬
                let statusText = 'ç­‰å¾…ä¸­';
                if (isCompleted) statusText = 'å·²å®Œæˆ';
                if (isCurrent) statusText = 'å½“å‰';
                
                moduleDiv.innerHTML = `
                    <div class="module-number">${index + 1}</div>
                    <div class="module-content">
                        <div class="module-header">
                            <div class="module-title">${module.name}</div>
                            <div class="module-status ${statusText}">${statusText}</div>
                        </div>
                        <div class="module-meta">
                            ${module.questions}é¢˜ Â· ${module.time}åˆ†é’Ÿ Â· ${module.category}
                        </div>
                        ${stats.attempts > 0 ? 
                            `<div class="module-stats">
                                ç»ƒä¹ ${stats.attempts}æ¬¡ Â· å†å²æ­£ç¡®ç‡ï¼š${historyAccuracy}%
                            </div>` : 
                            '<div class="module-stats">æ–°æ¨¡å—</div>'
                        }
                        ${!isCompleted ? `
                            <div class="module-actions">
                                <button class="btn btn-complete" onclick="completeModule(${index})">
                                    âœ… å®Œæˆ
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(moduleDiv);
            });
        }
        
        // æ›´æ–°æ¨¡å—æ’è¡Œ
        function updateRankList() {
            const container = document.getElementById('rankList');
            container.innerHTML = '';
            
            // è®¡ç®—æ¯ä¸ªæ¨¡å—çš„æ•°æ®
            const moduleRanks = studyData.modules.map(module => {
                const stats = studyData.moduleStats[module.id] || {
                    attempts: 0,
                    totalQuestions: 0,
                    totalCorrect: 0
                };
                
                const accuracy = stats.attempts > 0 ? 
                    ((stats.totalCorrect / stats.totalQuestions) * 100) : 0;
                
                return {
                    name: module.name,
                    accuracy: accuracy,
                    attempts: stats.attempts
                };
            }).filter(m => m.attempts > 0); // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ¨¡å—
            
            // æŒ‰æ­£ç¡®ç‡æ’åº
            moduleRanks.sort((a, b) => b.accuracy - a.accuracy);
            
            // åªæ˜¾ç¤ºå‰6ä¸ª
            const displayRanks = moduleRanks.slice(0, 6);
            
            displayRanks.forEach((module, index) => {
                const li = document.createElement('li');
                li.className = 'rank-item';
                
                // è¶‹åŠ¿åˆ¤æ–­ï¼ˆç®€åŒ–ç‰ˆï¼‰
                let trend = '';
                if (module.accuracy >= 80) {
                    trend = '<span class="trend-up">ğŸ“ˆ</span>';
                } else if (module.accuracy < 60) {
                    trend = '<span class="trend-down">âš ï¸</span>';
                }
                
                li.innerHTML = `
                    <div class="rank-name">${module.name}</div>
                    <div>
                        <span class="rank-value">${module.accuracy.toFixed(1)}%</span>
                        <span class="rank-trend">${trend}</span>
                    </div>
                `;
                container.appendChild(li);
            });
            
            if (displayRanks.length === 0) {
                container.innerHTML = '<li class="rank-item" style="color: #999; justify-content: center;">æš‚æ— æ•°æ®</li>';
            }
        }
        
        // æ›´æ–°ä»Šæ—¥çŠ¶æ€
        function updateDailyStatus() {
            const container = document.getElementById('dailyStatus');
            const completedCount = studyData.daily.completed.length;
            const totalModules = studyData.modules.length;
            const progress = completedCount / totalModules;
            const hour = new Date().getHours();
            
            let statusText = '';
            
            if (completedCount === 0) {
                statusText = 'æœ¬è½®å°šæœªå¼€å§‹ï¼Œä»ç¬¬ä¸€ä¸ªæ¨¡å—å¼€å§‹å§ï¼';
                if (hour >= 10) statusText += ' â°';
            } else if (progress < 0.5) {
                statusText = `æœ¬è½®å·²å®Œæˆ${completedCount}ä¸ªæ¨¡å—ï¼Œè¿›åº¦${Math.round(progress*100)}%`;
                if (hour >= 15 && progress < 0.3) statusText += ' ğŸš¨';
            } else if (progress < 1) {
                statusText = `æœ¬è½®å·²å®Œæˆ${completedCount}ä¸ªæ¨¡å—ï¼Œè¿›åº¦${Math.round(progress*100)}%`;
                if (progress >= 0.75) statusText += ' ğŸ’ª';
            } else {
                statusText = 'ğŸ‰ æœ¬è½®ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼';
            }
            
            // æ·»åŠ æ—¶é—´å»ºè®®
            if (hour < 12 && progress < 0.3) {
                statusText += '<br><small>å»ºè®®ï¼šä¸ŠåˆæŠ“ç´§æ—¶é—´</small>';
            } else if (hour >= 18 && progress < 1) {
                statusText += '<br><small>å»ºè®®ï¼šæ™šä¸Šæ˜¯å†²åˆºçš„å¥½æ—¶æœº</small>';
            }
            
            container.innerHTML = statusText;
        }
        
        // å®Œæˆæ¨¡å—
        function completeModule(index) {
            if (index !== studyData.currentModuleIndex) {
                alert('è¯·æŒ‰é¡ºåºå®Œæˆæ¨¡å—ï¼');
                return;
            }
            
            const module = studyData.modules[index];
            
            // è®¾ç½®æœ€å¤§é¢˜é‡
            document.getElementById('maxQuestions').textContent = module.questions;
            document.getElementById('wrongRange').max = module.questions;
            document.getElementById('wrongInput').max = module.questions;
            
            // è®¾ç½®é»˜è®¤å€¼
            document.getElementById('wrongRange').value = 0;
            document.getElementById('wrongInput').value = 0;
            document.getElementById('noteInput').value = '';
            updateWrongHint(0, module.questions);
            
            // æ˜¾ç¤ºæ¨¡å—ä¿¡æ¯
            document.getElementById('completeModuleInfo').innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${module.name}</div>
                <div style="font-size: 14px; color: #666;">
                    ${module.questions}é¢˜ Â· ${module.time}åˆ†é’Ÿ<br>
                    <small>${module.desc}</small>
                </div>
            `;
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('completeModal').style.display = 'flex';
            document.getElementById('wrongInput').focus();
        }
        
        // æ›´æ–°é”™é¢˜æç¤º
        function updateWrongHint(wrongCount, totalQuestions) {
            const hint = document.getElementById('wrongHint');
            const accuracy = ((totalQuestions - wrongCount) / totalQuestions * 100).toFixed(1);
            
            let text = `æ­£ç¡®ç‡ï¼š${accuracy}% - `;
            let color = '#666';
            
            if (wrongCount === 0) {
                text += 'å…¨å¯¹ï¼ç»§ç»­ä¿æŒï¼';
                color = '#4caf50';
            } else if (wrongCount <= totalQuestions * 0.2) {
                text += 'ä¼˜ç§€ï¼é”™é¢˜å¾ˆå°‘ï¼';
                color = '#4caf50';
            } else if (wrongCount <= totalQuestions * 0.4) {
                text += 'è‰¯å¥½ï¼Œå¯ä»¥æ›´å¥½ï¼';
                color = '#ff9800';
            } else {
                text += 'éœ€è¦åŠ å¼ºç»ƒä¹ ï¼';
                color = '#f44336';
            }
            
            hint.textContent = text;
            hint.style.color = color;
        }
        
        // æäº¤å®Œæˆ
        function submitComplete() {
            const wrongCount = parseInt(document.getElementById('wrongInput').value);
            const totalQuestions = parseInt(document.getElementById('maxQuestions').textContent);
            const note = document.getElementById('noteInput').value.trim();
            
            if (isNaN(wrongCount) || wrongCount < 0 || wrongCount > totalQuestions) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é”™é¢˜æ•°ï¼');
                return;
            }
            
            const index = studyData.currentModuleIndex;
            const module = studyData.modules[index];
            
            // æ›´æ–°æ¨¡å—ç»Ÿè®¡
            const stats = studyData.moduleStats[module.id];
            const correctCount = totalQuestions - wrongCount;
            const accuracy = (correctCount / totalQuestions) * 100;
            
            stats.attempts++;
            stats.totalQuestions += totalQuestions;
            stats.totalCorrect += correctCount;
            stats.lastAccuracy = stats.bestAccuracy;
            stats.bestAccuracy = Math.max(stats.bestAccuracy, accuracy);
            
            // è®°å½•å†å²
            stats.history.push({
                date: studyData.currentDate,
                wrongCount: wrongCount,
                accuracy: accuracy,
                note: note
            });
            
            // æ›´æ–°æ€»ä½“æ•°æ®
            studyData.overall.totalQuestions += totalQuestions;
            studyData.overall.totalCorrect += correctCount;
            studyData.overall.totalTime += module.time; // ä½¿ç”¨å»ºè®®æ—¶é—´
            
            // æ›´æ–°ä»Šæ—¥æ•°æ®
            studyData.todayCompleted++;
            studyData.daily.completed.push(module.id);
            studyData.daily.totalTime += module.time;
            
            // AIåé¦ˆ
            if (accuracy >= 90) {
                updateAIMessage('perfect');
            } else if (accuracy >= 70) {
                updateAIMessage('completed');
            } else {
                updateAIMessage('warning');
            }
            
            // æ£€æŸ¥é¢„è­¦
            if (accuracy < 60) {
                showAlert(`${module.name}æ­£ç¡®ç‡ä»…${accuracy.toFixed(1)}%ï¼Œéœ€è¦é‡ç‚¹å¤ä¹ ï¼`, 'danger');
            }
            
            // ========== æ ¸å¿ƒä¿®æ”¹3ï¼šæ£€æŸ¥æ˜¯å¦å®Œæˆä¸€è½®ï¼ˆæ‰€æœ‰æ¨¡å—éƒ½å®Œæˆï¼‰ ==========
            if (studyData.daily.completed.length >= studyData.modules.length) {
                // å®Œæˆä¸€è½®ï¼
                studyData.currentRound++;
                studyData.totalRounds++;
                
                // é‡ç½®æ‰€æœ‰æ¨¡å—ï¼Œå¼€å§‹æ–°ä¸€è½®
                studyData.daily.completed = [];
                studyData.currentModuleIndex = 0;
                studyData.todayCompleted = 0;
                studyData.daily.totalTime = 0;
                
                updateAIMessage('roundComplete');
            } else {
                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„æ¨¡å—
                studyData.currentModuleIndex = findFirstIncompleteModule();
            }
            // ============================================================
            
            closeCompleteModal();
            updateDisplay();
            
            // è‡ªåŠ¨æç¤ºä¸‹ä¸€ä¸ªæ¨¡å—
            if (studyData.currentModuleIndex >= 0 && studyData.currentModuleIndex < studyData.modules.length) {
                const nextModule = studyData.modules[studyData.currentModuleIndex];
                setTimeout(() => {
                    updateAIMessage('next', nextModule.name);
                }, 500);
            }
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡å—å¼¹çª—
        function showEditModal() {
            updateModuleEditList();
            document.getElementById('editModal').style.display = 'flex';
        }
    
        function updateModuleEditList() {
            const container = document.getElementById('moduleEditList');
            container.innerHTML = '';
            
            studyData.modules.forEach((module, index) => {
                const div = document.createElement('div');
                div.className = 'module-edit-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${module.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${module.category} Â· ${module.questions}é¢˜ Â· ${module.time}åˆ†é’Ÿ
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="moveModule(${index}, -1)" ${index === 0 ? 'disabled style="opacity:0.5;"' : ''}>
                            â¬†ï¸
                        </button>
                        <button onclick="moveModule(${index}, 1)" ${index === studyData.modules.length-1 ? 'disabled style="opacity:0.5;"' : ''}>
                            â¬‡ï¸
                        </button>
                        <button onclick="removeModule(${index})" style="color: #f44336;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // ç§»åŠ¨æ¨¡å—
        function moveModule(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= studyData.modules.length) return;
            
            // äº¤æ¢ä½ç½®
            [studyData.modules[index], studyData.modules[newIndex]] = 
            [studyData.modules[newIndex], studyData.modules[index]];
            
            updateModuleEditList();
        }
        
        // åˆ é™¤æ¨¡å—
        function removeModule(index) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ¨¡å—"${studyData.modules[index].name}"å—ï¼Ÿ`)) return;
            
            const moduleId = studyData.modules[index].id;
            
            // åˆ é™¤æ¨¡å—ç»Ÿè®¡æ•°æ®
            delete studyData.moduleStats[moduleId];
            
            // åˆ é™¤æ¨¡å—
            studyData.modules.splice(index, 1);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ¨¡å—ï¼Œéœ€è¦è°ƒæ•´currentModuleIndex
            if (index <= studyData.currentModuleIndex) {
                studyData.currentModuleIndex = Math.max(0, studyData.currentModuleIndex - 1);
            }
            
            updateModuleEditList();
            updateDisplay();
        }
        
        // æ˜¾ç¤ºæ·»åŠ æ¨¡å—å¼¹çª—
        function showAddModuleModal() {
            document.getElementById('newModuleName').value = '';
            document.getElementById('newModuleTime').value = 30;
            document.getElementById('newModuleQuestions').value = 20;
            document.getElementById('newModuleDesc').value = '';
            
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('addModuleModal').style.display = 'flex';
            document.getElementById('newModuleName').focus();
        }
        
        // æ·»åŠ æ¨¡å—
        function addModule() {
            const name = document.getElementById('newModuleName').value.trim();
            const category = document.getElementById('newModuleCategory').value;
            const time = parseInt(document.getElementById('newModuleTime').value);
            const questions = parseInt(document.getElementById('newModuleQuestions').value);
            const desc = document.getElementById('newModuleDesc').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥æ¨¡å—åç§°ï¼');
                return;
            }
            
            if (isNaN(time) || time < 5) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´ï¼ˆè‡³å°‘5åˆ†é’Ÿï¼‰ï¼');
                return;
            }
            
            if (isNaN(questions) || questions < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜é‡ï¼');
                return;
            }
            
            const newModule = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                name: name,
                category: category,
                time: time,
                questions: questions,
                desc: desc || "è¯·æŒ‰è¦æ±‚å®Œæˆç»ƒä¹ ",
                order: studyData.modules.length + 1
            };
            
            studyData.modules.push(newModule);
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            studyData.moduleStats[newModule.id] = {
                attempts: 0,
                totalQuestions: 0,
                totalCorrect: 0,
                bestAccuracy: 0,
                lastAccuracy: 0,
                history: []
            };
            
            closeAddModuleModal();
            showEditModal(); // è¿”å›ç¼–è¾‘é¡µé¢
            
            updateAIMessage('moduleAdded', name);
        }
        
        // ä¿å­˜æ¨¡å—è®¾ç½®
        function saveModules() {
            saveData();
            closeEditModal();
            updateDisplay();
            
            updateAIMessage('settingsSaved');
        }
        
        // æ˜¾ç¤ºé‡ç½®å¼¹çª—
        function showResetModal() {
            document.getElementById('resetModal').style.display = 'flex';
        }
        
        // é‡ç½®ä»Šæ—¥è¿›åº¦ï¼ˆç°åœ¨é‡ç½®çš„æ˜¯å½“å‰è½®æ¬¡è¿›åº¦ï¼‰
        function resetToday() {
            if (!confirm('ç¡®å®šé‡ç½®å½“å‰è½®æ¬¡è¿›åº¦å—ï¼Ÿæ‰€æœ‰å·²å®Œæˆçš„æ¨¡å—å°†è¢«æ ‡è®°ä¸ºæœªå®Œæˆï¼Œæœ¬è½®é‡æ–°å¼€å§‹ã€‚')) return;
            
            studyData.todayCompleted = 0;
            studyData.currentModuleIndex = 0;
            studyData.daily.completed = [];
            studyData.daily.totalTime = 0;
            
            closeResetModal();
            updateDisplay();
            
            updateAIMessage('reset');
        }
        
        // æ˜¾ç¤ºæ¸…ç©ºæ•°æ®å¼¹çª—
        function showClearAllModal() {
            document.getElementById('resetConfirmInput').value = '';
            document.getElementById('clearAllBtn').disabled = true;
            document.getElementById('clearAllModal').style.display = 'flex';
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!confirm('æœ€åç¡®è®¤ï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œæ— æ³•æ¢å¤ï¼')) return;
            
            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            studyData.currentDate = getTodayDate();
            studyData.currentRound = 1;
            studyData.currentModuleIndex = 0;
            studyData.todayCompleted = 0;
            studyData.totalRounds = 0;
            
            studyData.overall = {
                totalQuestions: 0,
                totalCorrect: 0,
                streakDays: 1,
                totalDays: 1,
                lastStudyDate: getTodayDate(),
                totalTime: 0
            };
            
            studyData.moduleStats = {};
            
            studyData.daily = {
                date: getTodayDate(),
                completed: [],
                startTime: Date.now(),
                totalTime: 0
            };
            
            studyData.history = [];
            
            // é‡ç½®ä¸ºé»˜è®¤æ¨¡å—
            studyData.modules = [
                { id: 1, name: "è¨€è¯­ç‰‡æ®µé˜…è¯»", category: "è¨€è¯­ç†è§£", time: 30, questions: 20, desc: "æ¯é¢˜â‰¤10å­—å†™æ ¸å¿ƒè®ºç‚¹", order: 1 },
                { id: 2, name: "é€»è¾‘åˆ¤æ–­", category: "åˆ¤æ–­æ¨ç†", time: 35, questions: 20, desc: "å†™è®ºè¯ç±»å‹+é€»è¾‘é“¾", order: 2 },
                { id: 3, name: "èµ„æ–™åˆ†æ", category: "èµ„æ–™åˆ†æ", time: 35, questions: 20, desc: "å£è¿°æœ€éš¾è®¡ç®—æ€è·¯", order: 3 },
                { id: 4, name: "è¨€è¯­å¡«ç©º", category: "è¨€è¯­ç†è§£", time: 30, questions: 20, desc: "è®°å½•çŠ¹è±«é€‰é¡¹å¹¶è¾¨æ", order: 4 },
                { id: 5, name: "å›¾å½¢æ¨ç†", category: "åˆ¤æ–­æ¨ç†", time: 25, questions: 20, desc: "æ³¨é”™/æ…¢é¢˜'æ­»åœ¨ä½•æ­¥'", order: 5 },
                { id: 6, name: "å®šä¹‰åˆ¤æ–­", category: "åˆ¤æ–­æ¨ç†", time: 25, questions: 20, desc: "å…ˆè‡ªè¯é‡è¿°å®šä¹‰", order: 6 },
                { id: 7, name: "ç±»æ¯”æ¨ç†", category: "åˆ¤æ–­æ¨ç†", time: 20, questions: 20, desc: "é”™é¢˜åå‘æ„é€ ä¾‹å­", order: 7 },
                { id: 8, name: "ç»ˆæä»»åŠ¡", category: "ç»¼åˆè®­ç»ƒ", time: 60, questions: 1, desc: "ç”³è®º/é”™æ€/ä½“èƒ½ä¸‰é€‰ä¸€", order: 8 }
            ];
            
            // åˆå§‹åŒ–é»˜è®¤æ¨¡å—çš„ç»Ÿè®¡
            studyData.modules.forEach(module => {
                studyData.moduleStats[module.id] = {
                    attempts: 0,
                    totalQuestions: 0,
                    totalCorrect: 0,
                    bestAccuracy: 0,
                    lastAccuracy: 0,
                    history: []
                };
            });
            
            closeClearAllModal();
            saveData();
            updateDisplay();
            
            updateAIMessage('clearAll');
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(studyData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `å…¬è€ƒå­¦ä¹ æ•°æ®_${getTodayDate()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            alert('æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼');
        }
        
        // æ›´æ–°AIæ¶ˆæ¯
        function updateAIMessage(type, extra = '') {
            const container = document.getElementById('aiMessage');
            let message = '';
            
            const hour = new Date().getHours();
            let timeOfDay = 'morning';
            if (hour >= 12 && hour < 18) timeOfDay = 'afternoon';
            if (hour >= 18) timeOfDay = 'evening';
            
            switch(type) {
                case 'morning':
                    message = aiMessages.morning[Math.floor(Math.random() * aiMessages.morning.length)];
                    break;
                case 'afternoon':
                    message = aiMessages.afternoon[Math.floor(Math.random() * aiMessages.afternoon.length)];
                    break;
                case 'evening':
                    message = aiMessages.evening[Math.floor(Math.random() * aiMessages.evening.length)];
                    break;
                case 'perfect':
                    message = aiMessages.perfect[Math.floor(Math.random() * aiMessages.perfect.length)];
                    break;
                case 'completed':
                    message = aiMessages.completed[Math.floor(Math.random() * aiMessages.completed.length)];
                    break;
                case 'warning':
                    message = aiMessages.warning[Math.floor(Math.random() * aiMessages.warning.length)];
                    break;
                case 'progress':
                    message = aiMessages.progress[Math.floor(Math.random() * aiMessages.progress.length)];
                    break;
                case 'lazy':
                    message = aiMessages.lazy[Math.floor(Math.random() * aiMessages.lazy.length)];
                    break;
                case 'streak':
                    message = `è¿ç»­å­¦ä¹ ç¬¬${studyData.overall.streakDays}å¤©ï¼ç»§ç»­ä¿æŒï¼`;
                    break;
                case 'reset':
                    message = 'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼';
                    break;
                case 'roundComplete':
                    message = `ğŸ‰ æ­å–œå®Œæˆç¬¬${studyData.currentRound-1}è½®ï¼å¼€å§‹ç¬¬${studyData.currentRound}è½®ï¼`;
                    break;
                case 'next':
                    message = `æ¥ä¸‹æ¥æ˜¯ï¼š${extra}ï¼Œç»§ç»­åŠ æ²¹ï¼`;
                    break;
                case 'moduleAdded':
                    message = `å·²æ·»åŠ æ–°æ¨¡å—ï¼š${extra}`;
                    break;
                case 'settingsSaved':
                    message = 'å­¦ä¹ è®¡åˆ’å·²æ›´æ–°ï¼';
                    break;
                case 'clearAll':
                    message = 'æ•°æ®å·²æ¸…ç©ºï¼Œé‡æ–°å¼€å§‹ï¼';
                    break;
                default:
                    message = aiMessages[timeOfDay][Math.floor(Math.random() * aiMessages[timeOfDay].length)];
            }
            
            container.textContent = message;
        }
        
        // æ˜¾ç¤ºè­¦å‘Š
        function showAlert(message, type = 'warning') {
            // è¿™é‡Œå¯ä»¥æ·»åŠ è§†è§‰è­¦å‘Šï¼Œæš‚ç”¨alert
            if (type === 'danger') {
                alert('âš ï¸ ' + message);
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é”™é¢˜æ•°æ»‘å—å’Œè¾“å…¥æ¡†åŒæ­¥
            const wrongRange = document.getElementById('wrongRange');
            const wrongInput = document.getElementById('wrongInput');
            
            if (wrongRange && wrongInput) {
                wrongRange.addEventListener('input', function() {
                    wrongInput.value = this.value;
                    const totalQuestions = parseInt(document.getElementById('maxQuestions').textContent);
                    updateWrongHint(parseInt(this.value), totalQuestions);
                });
                
                wrongInput.addEventListener('input', function() {
                    wrongRange.value = this.value;
                    const totalQuestions = parseInt(document.getElementById('maxQuestions').textContent);
                    updateWrongHint(parseInt(this.value), totalQuestions);
                });
            }
            
            // æ¸…ç©ºæ•°æ®ç¡®è®¤è¾“å…¥
            const resetConfirmInput = document.getElementById('resetConfirmInput');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            if (resetConfirmInput && clearAllBtn) {
                resetConfirmInput.addEventListener('input', function() {
                    clearAllBtn.disabled = this.value.toUpperCase() !== 'RESET';
                });
            }
            
            // è‡ªåŠ¨æ›´æ–°AIæ¶ˆæ¯
            setInterval(() => {
                const hour = new Date().getHours();
                let timeOfDay = 'morning';
                if (hour >= 12 && hour < 18) timeOfDay = 'afternoon';
                if (hour >= 18) timeOfDay = 'evening';
                
                updateAIMessage(timeOfDay);
            }, 30 * 60 * 1000); // æ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            
            // æ£€æŸ¥é•¿æ—¶é—´æ— æ“ä½œ
            let lastActivity = Date.now();
            const activityEvents = ['click', 'touchstart', 'keydown', 'mousemove'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    lastActivity = Date.now();
                });
            });
            
            setInterval(() => {
                if (Date.now() - lastActivity > 30 * 60 * 1000) { // 30åˆ†é’Ÿ
                    const completedCount = studyData.daily.completed.length;
                    if (completedCount < studyData.modules.length) {
                        updateAIMessage('lazy');
                        lastActivity = Date.now(); // é‡ç½®ï¼Œé¿å…é‡å¤æé†’
                    }
                }
            }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        }
        
        // å…³é—­å¼¹çª—å‡½æ•°
        function closeCompleteModal() {
            document.getElementById('completeModal').style.display = 'none';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function closeAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            showEditModal(); // è¿”å›ç¼–è¾‘é¡µé¢
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }
        
        function closeClearAllModal() {
            document.getElementById('clearAllModal').style.display = 'none';
        }
        
        // é¡µé¢åŠ è½½
        window.onload = init;
    </script>
</body>
</html>
